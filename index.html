<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Municipal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 50%, #ff9ff3 100%);
            min-height: 100vh;
            padding: 0;
            padding-bottom: 80px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
        }

        /* TABS NAVEGACI√ìN */
        .tabs-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
        }

        .tabs {
            display: flex;
            max-width: 800px;
            margin: 0 auto;
        }

        .tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            border: none;
            background: white;
            color: #999;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-top: 3px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .tab-icon {
            font-size: 22px;
        }

        .tab.active {
            color: #ff6b6b;
            border-top: 3px solid #ff6b6b;
            background: linear-gradient(to bottom, #fff5f5 0%, white 100%);
        }

        .tab:not(.active):hover {
            background: #fafafa;
        }

        /* CONTENT SECTIONS */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(255,107,107,0.3);
        }

        .config-section {
            display: none;
        }

        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .config-section {
            background: #fff5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .input-group {
            margin-bottom: 10px;
        }

        label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ffe0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .help-text {
            font-size: 11px;
            color: #999;
            margin-top: 3px;
        }

        button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }

        button:hover {
            background: linear-gradient(135deg, #ff5252 0%, #ff7043 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,107,107,0.3);
        }

        button:disabled {
            background: #ffcccc;
            cursor: not-allowed;
            transform: none;
        }

        .stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            padding: 15px;
            border-radius: 10px;
            color: white;
        }

        .stat-card.total {
            background: linear-gradient(135deg, #c23616 0%, #8e44ad 100%);
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }

        .invoices-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(255,107,107,0.3);
        }

        .invoice-item {
            padding: 15px;
            border-bottom: 1px solid #ffe0e0;
            transition: background 0.2s;
        }

        .invoice-item:last-child {
            border-bottom: none;
        }

        .invoice-item.selected {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%);
        }

        .invoice-item.paid {
            opacity: 0.5;
            background: #f5f5f5;
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .invoice-supplier {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .invoice-badge {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        .badge-pending {
            background: linear-gradient(135deg, #ff8c00 0%, #ff6f00 100%);
            color: #ffffff;
        }

        .badge-paid {
            background: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%);
            color: white;
        }

        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 13px;
            color: #666;
        }

        .invoice-amount {
            font-size: 20px;
            font-weight: bold;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .invoice-actions {
            display: flex;
            gap: 8px;
        }

        .btn-mark {
            flex: 1;
            padding: 10px;
            border: 2px solid #ff8e53;
            background: white;
            color: #ff6b6b;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-mark.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color: white;
            border-color: #ff6b6b;
        }

        .btn-mark:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .partial-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #ff8e53;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 8px;
        }

        .partial-input:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #ffe0e0;
            border-top: 3px solid #ff6b6b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: linear-gradient(135deg, #ffcccc 0%, #ffb3b3 100%);
            color: #cc0000;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        /* ESTADO FINANCIERO STYLES */
        .balance-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(15, 188, 249, 0.35);
        }

        .balance-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .balance-item:last-child {
            border-bottom: none;
        }

        .balance-bank {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .balance-ref {
            font-size: 12px;
            color: #999;
            margin-left: 8px;
        }

        .balance-amount {
            font-weight: 700;
            font-size: 16px;
            background: linear-gradient(135deg, #0fbcf9 0%, #4834df 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .total-disponible {
            background: linear-gradient(135deg, #0fbcf9 0%, #4834df 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .total-disponible-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .total-disponible-value {
            font-size: 32px;
            font-weight: 800;
        }

        .movement-item {
            padding: 15px;
            border-bottom: 1px solid #ffe0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .movement-item:last-child {
            border-bottom: none;
        }

        .movement-info {
            flex: 1;
        }

        .movement-desc {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .movement-date {
            font-size: 12px;
            color: #999;
        }

        .movement-amount {
            font-weight: 700;
            font-size: 16px;
        }

        .movement-amount.positive {
            color: #10ac84;
        }

        .movement-amount.negative {
            color: #ff6b6b;
        }

        .refresh-btn {
            width: auto;
            padding: 10px 20px;
            font-size: 13px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- TABS NAVEGACI√ìN -->
    <div class="tabs-container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('proveedores', event)">
                <div class="tab-icon">üè¶</div>
                <div>Proveedores</div>
            </button>
            <button class="tab" onclick="switchTab('finanzas', event)">
                <div class="tab-icon">üí∞</div>
                <div>Finanzas</div>
            </button>
        </div>
    </div>

    <!-- CONTENIDO PROVEEDORES -->
    <div id="proveedores-content" class="tab-content active">
        <div class="container">
            <div class="header">
                <h1>üí≥ Pagos Proveedores</h1>
                
                <div id="stats" style="display: none;">
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-label">Deuda Total</div>
                            <div class="stat-value" id="totalDebt">$0</div>
                        </div>
                        <div class="stat-card total">
                            <div class="stat-label">üí≥ Total a Pagar Hoy</div>
                            <div class="stat-value" id="todayTotal">$0</div>
                        </div>

                        <button id="registerBtn" onclick="registerTodayPayments()" style="margin-top:10px;">
                          üßæ Registrar pago de hoy
                        </button>

                        <div id="sheetUpdate" style="
                             text-align:center;
                             margin-top:8px;
                             font-size:13px;
                             color:#999;">
                        </div>
                    </div>
                </div>
            </div>

            <div id="error" class="error" style="display: none;"></div>

            <div id="loading" class="loading" style="display: block;">
                <div class="spinner"></div>
                <div>Cargando facturas...</div>
            </div>

            <div id="invoicesContainer" class="invoices-container"></div>
        </div>
    </div>

    <!-- CONTENIDO FINANZAS -->
    <div id="finanzas-content" class="tab-content">
        <div class="container">
            <div class="header">
                <h1>üí∞ Estado Financiero</h1>
                <div style="text-align:center; margin-top:8px; font-size:13px; color:#999;" id="finanzasUpdate">√öltima actualizaci√≥n: ‚Äî</div>
            </div>

            <div id="finanzasError" class="error" style="display: none;"></div>

            <div id="finanzasLoading" class="loading" style="display: block;">
                <div class="spinner"></div>
                <div>Cargando estado financiero...</div>
            </div>

            <div id="finanzasContainer" style="display: none;">
                <!-- TOTAL DISPONIBLE -->
                <div class="total-disponible">
                    <div class="total-disponible-label">TOTAL DISPONIBLE</div>
                    <div class="total-disponible-value" id="totalDisponible">$ 0,00</div>
                </div>

                <!-- SALDOS POR BANCO -->
                <div class="balance-section">
                    <div class="balance-title">üè¶ Saldos por Cuenta</div>
                    <div id="saldosContainer"></div>
                </div>

                <!-- MOVIMIENTOS DEL D√çA -->
                <div class="balance-section">
                    <div class="balance-title">üìä Movimientos del D√≠a</div>
                    <div id="movimientosContainer"></div>
                </div>

                <button class="refresh-btn" onclick="loadFinanzas()">üîÑ Actualizar Datos</button>
            </div>
        </div>
    </div>

    <script>
        let invoices = [];
        const SHEET_ID = '17EPXK3fUPbCeoditXmqxq8Fn4-d40bh6HV7sQOn1kBo';
        const SHEET_NAME = 'Deudas';
        const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyMWRuu8nrrrGMGFjmU_jaNtnhVSGWCa204H5tsa-5fVuHSKTSaI3Mx2j634_sbk0OxRw/exec';
        
        // CONFIGURACI√ìN FINANZAS
        const FINANZAS_SHEET_ID = '1gt8VMJGb4OLt3XGA6vOGOqQUAxvclG6hAwfEL7dDobk';

        let currentTab = 'proveedores';

        // ============ NAVEGACI√ìN TABS ============
        function switchTab(tabName, event) {
            currentTab = tabName;
            
            // Actualizar tabs activas
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.closest('.tab').classList.add('active');

            // Mostrar contenido correspondiente
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            if (tabName === 'proveedores') {
                document.getElementById('proveedores-content').classList.add('active');
            } else if (tabName === 'finanzas') {
                document.getElementById('finanzas-content').classList.add('active');
            }
        }

        // ============ FUNCIONES PROVEEDORES (ORIGINALES) ============
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-AR', {
                style: 'currency',
                currency: 'ARS',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function formatDate(value) {
          if (!value || value === '-') return '-';

          // Caso 1: Date real
          if (value instanceof Date) {
            return value.toLocaleDateString('es-AR');
          }

          // Caso 2: GViz Date(yyyy,mm,dd,...)
          if (typeof value === 'string') {
            const gvizMatch = value.match(/Date\((\d+),(\d+),(\d+)/);
            if (gvizMatch) {
              const y = Number(gvizMatch[1]);
              const m = Number(gvizMatch[2]);
              const d = Number(gvizMatch[3]);
              return new Date(y, m, d).toLocaleDateString('es-AR');
            }

            // Caso 3: string tipo DD/MM/YYYY ‚Üí usar tal cual
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(value)) {
              return value;
            }
          }

          return '-';
        }

        function parseGvizDate(v) {
          if (!v) return null;

          // GViz: Date(yyyy,mm,dd,...)
          if (typeof v === 'string' && v.startsWith('Date(')) {
            const m = v.match(/Date\((\d+),(\d+),(\d+)/);
            if (m) return new Date(+m[1], +m[2], +m[3]);
          }

          // String DD/MM/YYYY
          if (typeof v === 'string' && /^\d{2}\/\d{2}\/\d{4}$/.test(v)) {
            const [d, m, y] = v.split('/');
            return new Date(y, m - 1, d);
          }

          // ISO / Date real
          const d = new Date(v);
          return isNaN(d) ? null : d;
       }

        async function registerTodayPayments() {
          const items = [];

          invoices.forEach(inv => {
            if (inv.selected) {
              items.push({
                sheetRow: inv.sheetRow,
                proveedor: inv.supplier,
                tipo: "COMPLETO",
                monto: inv.amount
              });
            } else if (inv.partial && inv.partialAmount > 0) {
              items.push({
                sheetRow: inv.sheetRow,
                proveedor: inv.supplier,
                tipo: "PARCIAL",
                monto: inv.partialAmount
              });
            }
          });

          if (!items.length) {
            alert("‚ö†Ô∏è No hay pagos seleccionados.");
            return;
          }

          const btn = document.getElementById('registerBtn');
          if (btn) btn.disabled = true;

          try {
            const payload = {
              spreadsheetId: SHEET_ID,
              targetSheetName: "Pagos_Hoy",
              items
            };

            const res = await fetch(WEBAPP_URL, {
              method: "POST",
              headers: { "Content-Type": "text/plain;charset=utf-8" },
              body: JSON.stringify(payload)
            });

            const out = await res.json();

            if (!out.ok) throw new Error(out.message || 'Error registrando pagos');

            alert(`‚úÖ ${out.message}\nSe registr√≥ en la hoja "Pagos_Hoy".`);
            await loadInvoices();

            invoices.forEach(inv => {
              inv.selected = false;
              inv.partial = false;
              inv.partialAmount = 0;
            });

          } catch (err) {
            console.error(err);
            alert('‚ùå No se pudo registrar en el Sheet: ' + (err?.message || err));
          } finally {
            if (btn) btn.disabled = false;
          }
        }
      
        async function loadInvoices() {
            const sheetId = SHEET_ID;
            const sheetName = SHEET_NAME;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';

            try {
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
                const response = await fetch(url);
                const text = await response.text();

                const start = text.indexOf('(');
                const end = text.lastIndexOf(');');
                const json = JSON.parse(text.substring(start + 1, end));

                let lastUpdateCell = null;

                for (let i = json.table.rows.length - 1; i >= 0; i--) {
                  const v = json.table.rows[i]?.c?.[5]?.v;
                  if (v) { lastUpdateCell = v; break; }
                }

                const fecha = parseGvizDate(lastUpdateCell);

                document.getElementById('sheetUpdate').textContent =
                  fecha
                    ? '√öltima actualizaci√≥n: ' + fecha.toLocaleString('es-AR')
                    : '√öltima actualizaci√≥n: ‚Äî';

                const rows = json.table.rows;

               const firstCell = (rows[0]?.c?.[0]?.v ?? '').toString().trim().toLowerCase();
               const isAutoHeader = firstCell === 'columna 1';

               const rowsForData = isAutoHeader ? rows.slice(1) : rows;
               
               const baseRow = 2;

               const indexed = rowsForData.map((r, i) => ({ r, sheetRow: baseRow + i }));

               const dataIndexed = indexed.filter(({ r }) => {
                 const supplier = (r.c?.[0]?.v ?? '').toString().trim();
                 const amount = r.c?.[1]?.v;
                 return supplier !== '' || (amount != null && amount !== '');
               });

               invoices = dataIndexed.map(({ r: row, sheetRow }, idx) => {
                 const isPaid = row.c?.[4]?.v === true;
                 const estado = (row.c?.[6]?.v ?? '').toString().trim();
                 return {
                   id: idx + 1,
                   sheetRow,
                   supplier: row.c?.[0]?.v || '',
                   amount: parseFloat(row.c?.[1]?.v || 0),
                   issueDate: parseGvizDate(row.c?.[2]?.v),
                   payDate: parseGvizDate(row.c?.[3]?.v),
                   estado,
                   isPaid,
                   selected: false,
                   partial: false,
                   partialAmount: 0
                 };
               });

                document.getElementById('stats').style.display = 'block';
                renderInvoices();
                updateStats();

            } catch (err) {
                showError('Error al cargar. Verifica que la hoja sea p√∫blica y los datos sean correctos.');
                console.error(err);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function toggleInvoice(id, type) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice || invoice.isPaid) return;

            if (type === 'full') {
                invoice.selected = !invoice.selected;
                invoice.partial = false;
                invoice.partialAmount = 0;
            } else if (type === 'partial') {
                invoice.partial = !invoice.partial;
                invoice.selected = false;
                if (!invoice.partial) {
                    invoice.partialAmount = 0;
                }
            }

            renderInvoices();
            updateStats();
        }

        function updatePartialAmount(id, value) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;

            const amount = parseFloat(value) || 0;
            invoice.partialAmount = Math.min(amount, invoice.amount);
            updateStats();
        }

        function renderInvoices() {
            const container = document.getElementById('invoicesContainer');
            
            if (invoices.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <p>No hay facturas para mostrar</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = invoices.map(inv => `
                <div class="invoice-item ${inv.selected || inv.partial ? 'selected' : ''} ${inv.isPaid ? 'paid' : ''}">
                    <div class="invoice-header">
                      <div class="invoice-supplier">${inv.supplier}</div>
                      ${(!inv.isPaid && inv.estado?.toUpperCase() === 'SALDO PENDIENTE')
                        ? `<span class="invoice-badge badge-pending">SALDO PENDIENTE</span>`
                        : ''
                      }
                    </div>
                    
                    <div class="invoice-amount">${formatCurrency(inv.amount)}</div>
                    
                    <div class="invoice-details">
                        <div>üìÖ Emisi√≥n: ${formatDate(inv.issueDate)}</div>
                        <div>‚úÖ Ultimo Pago: ${formatDate(inv.payDate)}</div>
                    </div>
                    
                    ${!inv.isPaid ? `
                        <div class="invoice-actions">
                            <button class="btn-mark ${inv.selected ? 'active' : ''}" 
                                    onclick="toggleInvoice(${inv.id}, 'full')"
                                    ${inv.partial ? 'disabled' : ''}>
                                ${inv.selected ? '‚úì Completo' : 'Pago Completo'}
                            </button>
                            <button class="btn-mark ${inv.partial ? 'active' : ''}" 
                                    onclick="toggleInvoice(${inv.id}, 'partial')"
                                    ${inv.selected ? 'disabled' : ''}>
                                ${inv.partial ? '‚úì Parcial' : 'Pago Parcial'}
                            </button>
                        </div>
                        ${inv.partial ? `
                            <input type="number" 
                                   class="partial-input" 
                                   placeholder="Monto a pagar"
                                   value="${inv.partialAmount || ''}"
                                   max="${inv.amount}"
                                   oninput="updatePartialAmount(${inv.id}, this.value)">
                        ` : ''}
                    ` : ''}
                </div>
            `).join('');
        }

        function updateStats() {
            const pending = invoices.filter(inv => !inv.isPaid);
            const totalDebt = pending.reduce((sum, inv) => sum + inv.amount, 0);
            
            const todayTotal = invoices.reduce((sum, inv) => {
                if (inv.selected) return sum + inv.amount;
                if (inv.partial) return sum + inv.partialAmount;
                return sum;
            }, 0);

            document.getElementById('totalDebt').textContent = formatCurrency(totalDebt);
            document.getElementById('todayTotal').textContent = formatCurrency(todayTotal);
        }

        // ============ FUNCIONES FINANZAS ============
        async function loadFinanzas() {
            document.getElementById('finanzasLoading').style.display = 'block';
            document.getElementById('finanzasError').style.display = 'none';
            document.getElementById('finanzasContainer').style.display = 'none';

            try {
                // Cargar SALDOS
                const saldosUrl = `https://docs.google.com/spreadsheets/d/${FINANZAS_SHEET_ID}/gviz/tq?tqx=out:json&sheet=Saldos`;
                const saldosResponse = await fetch(saldosUrl);
                const saldosText = await saldosResponse.text();
                const saldosStart = saldosText.indexOf('(');
                const saldosEnd = saldosText.lastIndexOf(');');
                const saldosJson = JSON.parse(saldosText.substring(saldosStart + 1, saldosEnd));

                // Cargar MOVIMIENTOS
                const movimientosUrl = `https://docs.google.com/spreadsheets/d/${FINANZAS_SHEET_ID}/gviz/tq?tqx=out:json&sheet=Movimientos`;
                const movimientosResponse = await fetch(movimientosUrl);
                const movimientosText = await movimientosResponse.text();
                const movimientosStart = movimientosText.indexOf('(');
                const movimientosEnd = movimientosText.lastIndexOf(');');
                const movimientosJson = JSON.parse(movimientosText.substring(movimientosStart + 1, movimientosEnd));

                // Obtener √∫ltima actualizaci√≥n de D1 (columna 3, √≠ndice 0-based)
                let lastUpdateCell = null;
                if (saldosJson.table.rows.length > 0) {
                    lastUpdateCell = saldosJson.table.rows[0]?.c?.[3]?.v; // D1 = √≠ndice 3
                }

                const fechaFinanzas = parseGvizDate(lastUpdateCell);
                document.getElementById('finanzasUpdate').textContent =
                    fechaFinanzas
                        ? '√öltima actualizaci√≥n: ' + fechaFinanzas.toLocaleString('es-AR')
                        : '√öltima actualizaci√≥n: ‚Äî';

                // Procesar SALDOS
                const saldosRows = saldosJson.table.rows;
                let totalDisponible = 0;
                let saldosHTML = '';

                // Saltar el encabezado si existe
                const firstSaldoCell = (saldosRows[0]?.c?.[0]?.v ?? '').toString().trim().toLowerCase();
                const saldosDataRows = (firstSaldoCell === 'banco' || firstSaldoCell === 'columna 1') 
                    ? saldosRows.slice(1) 
                    : saldosRows;

                saldosDataRows.forEach(row => {
                    const banco = (row.c?.[0]?.v || '').toString().trim();
                    const referencia = (row.c?.[1]?.v !== null && row.c?.[1]?.v !== undefined) 
                        ? row.c[1].v.toString().trim() 
                        : '';
                    const saldo = parseFloat(row.c?.[2]?.v || 0);

                    if (banco || referencia || saldo !== 0) {
                        totalDisponible += saldo;
                        saldosHTML += `
                            <div class="balance-item">
                                <div>
                                    <span class="balance-bank">${banco}</span>
                                    ${referencia ? `<span class="balance-ref">${referencia}</span>` : ''}
                                </div>
                                <div class="balance-amount">${formatCurrency(saldo)}</div>
                            </div>
                        `;
                    }
                });

                // Procesar MOVIMIENTOS
                const movimientosRows = movimientosJson.table.rows;
                let movimientosHTML = '';

                // Saltar el encabezado si existe
                const firstMovCell = (movimientosRows[0]?.c?.[0]?.v ?? '').toString().trim().toLowerCase();
                const movimientosDataRows = (firstMovCell === 'fecha' || firstMovCell === 'columna 1') 
                    ? movimientosRows.slice(1) 
                    : movimientosRows;

                movimientosDataRows.forEach(row => {
                    const fecha = row.c?.[0]?.f || row.c?.[0]?.v || '';
                    const monto = parseFloat(row.c?.[1]?.v || 0);
                    const descripcion = row.c?.[2]?.v || '';

                    if (descripcion) {
                        const isPositive = monto >= 0;
                        movimientosHTML += `
                            <div class="movement-item">
                                <div class="movement-info">
                                    <div class="movement-desc">${descripcion}</div>
                                    <div class="movement-date">${fecha}</div>
                                </div>
                                <div class="movement-amount ${isPositive ? 'positive' : 'negative'}">
                                    ${formatCurrency(Math.abs(monto))}
                                </div>
                            </div>
                        `;
                    }
                });

                // üëá PEGAR JUSTO AC√Å
                document.getElementById('saldosContainer').innerHTML = saldosHTML;
                document.getElementById('movimientosContainer').innerHTML = movimientosHTML;
                document.getElementById('totalDisponible').textContent = formatCurrency(totalDisponible);
                document.getElementById('finanzasContainer').style.display = 'block';

            } catch (err) {
                console.error('Error al cargar finanzas:', err);
                const errorDiv = document.getElementById('finanzasError');
                errorDiv.textContent = 'Error al cargar estado financiero. Verifica que el Sheet "Estado Financiero" sea p√∫blico.';
                errorDiv.style.display = 'block';
            } finally {
                document.getElementById('finanzasLoading').style.display = 'none';
            }
        }

        // ============ INICIALIZACI√ìN ============
        window.addEventListener('load', () => {
            loadInvoices();
            loadFinanzas();
        });
    </script>
</body>
</html>
